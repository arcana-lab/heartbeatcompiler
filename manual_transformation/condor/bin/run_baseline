#!/bin/bash

numRuns=5

CURRENT_PATH="`pwd`"
RESULTS_FOLDER="${CURRENT_PATH}/../results/current_machine"
BENCHMARKS_FOLDER="${CURRENT_PATH}/../benchmarks"

pushd ./ ;

cd ${BENCHMARKS_FOLDER} ;
make clean ; make ;

# Compile baseline binaries
BINARY_FOLDER="${RESULTS_FOLDER}/binary"
mkdir -p ${BINARY_FOLDER} ;

for bench in `ls` ; do
  if ! test -d ${bench} ; then
    continue ;
  fi
	if [ ${bench} == "scripts" ] ; then
		continue ;
	fi

  if test -e "${BINARY_FOLDER}/${bench}/baseline/baseline" ; then
    echo "${bench} already compiled" ;
    continue ;
  fi

  cd ${bench} ;
  mkdir -p "${BINARY_FOLDER}/${bench}/baseline" ;

  # compile and store the binary
  echo "compiling ${bench}" ;
  make baseline ;
  cp baseline "${BINARY_FOLDER}/${bench}/baseline/baseline" ;

  cd ../ ;
done

# Collect time results for baseline binaries
TIME_FOLDER="${RESULTS_FOLDER}/time"
mkdir -p ${TIME_FOLDER} ;

for bench in `ls` ; do
  if ! test -d ${bench} ; then
    continue ;
  fi
	if [ ${bench} == "scripts" ] ; then
		continue ;
	fi

  # check if the compiled binary exists
  if ! test -e "${BINARY_FOLDER}/${bench}/baseline/baseline" ; then
    echo "binary for ${bench} not found" ;
    continue ;
  fi

  if test -e "${TIME_FOLDER}/${bench}/baseline/time.txt" ; then
    echo "${bench} already have time results" ;
    continue ;
  fi

  cd ${bench} ;
  cp "${BINARY_FOLDER}/${bench}/baseline/baseline" . ;
  mkdir -p "${TIME_FOLDER}/${bench}/baseline" ;

  echo "running ${bench} ${numRuns} times to collect baseline time results" ;
  for i in `seq 1 ${numRuns}` ; do
    /usr/bin/time -p taskset -c 0 ./baseline 2>&1 | grep "real" | awk '{ print $2 }' >> "${TIME_FOLDER}/${bench}/baseline/time.txt" ;
  done

  cd ../ ;
done ;

# Collect metrics for baseline binaries
EVENTS="branch-misses,LLC-load-misses,instructions"
PERF_FOLDER="${RESULTS_FOLDER}/perf"
mkdir -p ${PERF_FOLDER} ;

for bench in `ls` ; do
  if ! test -d ${bench} ; then
    continue ;
  fi
	if [ ${bench} == "scripts" ] ; then
		continue ;
	fi

  # check if the compiled binary exists
  if ! test -e "${BINARY_FOLDER}/${bench}/baseline/baseline" ; then
    echo "binary for ${bench} not found" ;
    continue ;
  fi

  if test -e "${PERF_FOLDER}/${bench}/baseline/perf.txt" ; then
    echo "${bench} already have perf results" ;
    continue ;
  fi

  cd ${bench} ;
  cp "${BINARY_FOLDER}/${bench}/baseline/baseline" . ;
  mkdir -p "${PERF_FOLDER}/${bench}/baseline" ;

  echo "running ${bench} ${numRuns} times to collect baseline perf results" ;
  for i in `seq 1 ${numRuns}` ; do
    taskset -c 0 perf stat -e ${EVENTS} ./baseline >> "${PERF_FOLDER}/${bench}/baseline/perf.txt" 2>&1 ;
  done

  cd ../ ;
done ;

popd ;

exit 0
