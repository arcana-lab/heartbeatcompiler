MACROS_HEARTBEAT_MANUAL += -DUSE_HB_MANUAL $(MACROS_HEARTBEAT)
FRONTEND_FLAGS_HEARTBEAT_MANUAL = \
	-O1 -emit-llvm \
	-Xclang -disable-llvm-passes \
	-Xclang -no-opaque-pointers \
	-Xclang -ffp-contract=off
FLAGS_HEARTBEAT_MANUAL += $(FLAGS_HEARTBEAT)
OPTS_HEARTBEAT_MANUAL += $(OPTS_HEARTBEAT)
LIBS_HEARTBEAT_MANUAL += $(LIBS_HEARTBEAT)

# ============================================
# Heartbeat Manual
# ============================================
main_manual.bc: main.cpp
	$(CXX) $(MACROS_HEARTBEAT_MANUAL) $(FRONTEND_FLAGS_HEARTBEAT_MANUAL) $(FLAGS_HEARTBEAT_MANUAL) -c $^ -o $@

heartbeat_manual.bc: heartbeat_manual.cpp
	$(CXX) $(MACROS_HEARTBEAT_MANUAL) $(FRONTEND_FLAGS_HEARTBEAT_MANUAL) $(FLAGS_HEARTBEAT_MANUAL) -c $^ -o $@

heartbeat_manual_linked.bc: main_manual.bc heartbeat_manual.bc
	llvm-link $^ -o $@

heartbeat_manual_normalized.bc: heartbeat_manual_linked.bc
	noelle-norm $^ -o $@

hbm: heartbeat_manual
hb_manual: heartbeat_manual
heartbeat_manual: heartbeat_manual_normalized.bc bench.cpp loop_handler.cpp
	make preprocess
ifeq ($(ENABLE_ROLLFORWARD), true)
	make heartbeat_manual_rf
	cp heartbeat_manual_rf $@
else
	$(CXX) $(MACROS_HEARTBEAT_MANUAL) $(FLAGS_HEARTBEAT_MANUAL) $(OPTS_HEARTBEAT_MANUAL) $^ -o $@ $(LIBS_HEARTBEAT_MANUAL)
endif
	make postprocess

run_hbm: run_heartbeat_manual
run_hb_manual: run_heartbeat_manual
run_heartbeat_manual: heartbeat_manual
ifneq ($(WORKERS), 0)
	TASKPARTS_NUM_WORKERS=$(WORKERS) \
	TASKPARTS_BENCHMARK_WARMUP_SECS=$(WARMUP_SECS) \
	TASKPARTS_BENCHMARK_NUM_REPEAT=$(NUM_REPEAT) \
	TASKPARTS_BENCHMARK_VERBOSE=$(VERBOSE) \
	TASKPARTS_CPU_BASE_FREQUENCY_KHZ=$(CPU_FREQUENCY_KHZ) \
	TASKPARTS_KAPPA_USEC=$(KAPPA_USECS) \
	./$< $(ARGS)
else
	TASKPARTS_BENCHMARK_WARMUP_SECS=$(WARMUP_SECS) \
	TASKPARTS_BENCHMARK_NUM_REPEAT=$(NUM_REPEAT) \
	TASKPARTS_BENCHMARK_VERBOSE=$(VERBOSE) \
	TASKPARTS_CPU_BASE_FREQUENCY_KHZ=$(CPU_FREQUENCY_KHZ) \
	TASKPARTS_KAPPA_USEC=$(KAPPA_USECS) \
	./$< $(ARGS)
endif

# ============================================
# Heartbeat Manual (Rollforward)
# ============================================
heartbeat_manual.s: heartbeat_manual.cpp
	$(CXX) $(MACROS_HEARTBEAT_MANUAL) $(FLAGS_HEARTBEAT_MANUAL) $(OPTS_HEARTBEAT_MANUAL) $< -S -o $@

heartbeat_manual.rf.s: heartbeat_manual.s
	ROLLFORWARD_PATH=$(ROLLFORWARD_PATH) $(ROLLFORWARD_COMPILER) $< $@

heartbeat_manual.rf.o: heartbeat_manual.rf.s
	$(CXX) -I $(ROLLFORWARD_INCLUDE) $< -c -o $@

rollforward_manual.o: $(ROLLFORWARD_INCLUDE)/rollforward.c
	$(CXX) $< -c -o $@

heartbeat_manual_rf: heartbeat_manual.rf.o rollforward_manual.o loop_handler.cpp bench.cpp main.cpp
	$(CXX) $(MACROS_HEARTBEAT_MANUAL) $(FLAGS_HEARTBEAT_MANUAL) $(OPTS_HEARTBEAT_MANUAL) $^ -o $@ $(LIBS_HEARTBEAT_MANUAL)
